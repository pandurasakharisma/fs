<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <title>FS CRM - Cari Pelanggan</title>
    <style>
        .categories-place-box {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background-color: rgba(var(--white), 1);
            border: 1px solid rgba(var(--line-color), 1);
            border-radius: 6px;
        }

        .recent-icon img {
            width: 26px;
            height: 48px;
            margin-right: 5px;
        }
        #header{
            position: fixed;
            width: 100%;
            max-width: 600px;
            margin-top: 0;
            padding-top: 10px;
            z-index: +2;
        }
        #modpop {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* muncul dari bawah */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 9999;
        }

        #olay {
            position: absolute;
            inset: 0;
            background: #000;
            opacity: .6;
        }

        #modpop .theme-content-bg {
            background: #fff;
            width: 100%;
            max-width: 500px;
            border-radius: 16px 16px 0 0;
            overflow-y: auto;
            max-height: 80vh;
            transition: transform 0.4s ease-in-out;
            z-index: 10000;
            padding: 0 20px;
            position: relative;
        }

        #modpop.show {
            visibility: visible;
            opacity: 1;
        }

        .addcust svg {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            z-index: 9999;
            border-radius: 50%;
            background: #c53f3f;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: pulse 1.5s infinite;
            transition: transform 0.2s ease-in-out;
        }
        .pulse{animation: pulse 1.5s infinite;}
        .addcust svg path {stroke: #fff!important;}
        @keyframes pulse {
            0% {transform: scale(1);box-shadow: 0 0 0 0 rgba(197, 63, 63, 0.4);}
            70% {transform: scale(1.1);box-shadow: 0 0 0 20px rgba(197, 63, 63, 0);}
            100% {transform: scale(1);box-shadow: 0 0 0 0 rgba(197, 63, 63, 0);}
        }

        .addcust svg:hover {transform: scale(1.15);}
        #modpop .tbf{
            position: fixed;
            bottom: 0;
            margin-bottom: 10px;
            z-index: +2;
            width: calc(100% - 20px);
            background: #fff;
            max-width: 450px;
        }
        .skeleton-loader {
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
            padding: 10px;
        }

        .skeleton-loader-line {
            height: 14px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            border-radius: 4px;
            animation: shimmer 1.5s infinite;
            margin: 6px 0;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .e404{ width: 100%; margin: 10px 0 20px; height: 100vh; position: fixed; background: #fff; left: 0; top: 0; }
    </style>
</head>

<body>
    <header id="header" class="main-header inner-page-header">
        <div class="custom-container">
            <div class="header-panel">
            <div class="flex-spacing gap-2 w-100" style="align-items: center; display: flex;">
                
                <!-- Tombol Back -->
                <a href="index.html" class="back-btn">
                <i class="iconsax icon-btn" data-icon="chevron-left" height="40" width="40" style="border: none;margin-left: -10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M15.0013 20.6695C14.8113 20.6695 14.6213 20.5995 14.4713 20.4495L7.95125 13.9295C6.89125 12.8695 6.89125 11.1295 7.95125 10.0695L14.4713 3.54953C14.7613 3.25953 15.2413 3.25953 15.5312 3.54953C15.8212 3.83953 15.8212 4.31953 15.5312 4.60953L9.01125 11.1295C8.53125 11.6095 8.53125 12.3895 9.01125 12.8695L15.5312 19.3895C15.8212 19.6795 15.8212 20.1595 15.5312 20.4495C15.3813 20.5895 15.1912 20.6695 15.0013 20.6695Z" fill="#292D32"></path>
                    </svg>
                </i>
                </a>

                <!-- Input Search (DITARUH DI TENGAH) -->
                <div class="location-box flex-grow-1" style="
                    background-color: rgba(var(--box-bg), 1);
                    display: flex;
                    align-items: center;
                    border-radius: 6px;
                    padding: 8px;
                ">
                    <img class="icon" src="./assets/images/svg/gps.svg" alt="location" style="width:18px; margin-right:6px;">
                    <input type="text" id="searchInput" class="form-control border-0 p-0" placeholder="Enter destination" style="background: none;flex:1; box-shadow:none;">
                    <img id="clearBtn" class="clear-btn" width="12" style="display:none; cursor:pointer;margin-right:6px;" src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e" alt="clear">
                </div>
            </div>
            </div>
        </div>
    </header>

    <main>
        <section style='padding:65px 0 0;'>
            <ul id="placeList" class="recent-place-list">
                <li class="recent-place-item" style="display: none;">
                    <div class="recent-box">
                        <div class="recent-icon">
                            <img class="icon" src="./assets/images/svg/location-fill.svg" alt="location">
                        </div>
                        <div>
                            <h5 class="card-name"></h5>
                            <p class="address"></p>
                        </div>
                    </div>
                </li>
            </ul>
            <i class="iconsax addcust" data-icon="add" id="addform">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 12H18" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M12 18V6" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </i>
        </section>
        <div id="modpop">
            <div id="olay"></div>
            <div class="theme-content-bg">
                <form class="theme-form" style="margin-bottom:100px;">
                    <div class="form-group">
                        <label class="form-label mb-2" for="CardName">Nama Pelanggan</label>
                        <input type="text" class="form-control" id="CardName" name="CardName" placeholder="Masukkan nama pelanggan" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label mb-2" for="Address">Alamat</label>
                        <input type="text" class="form-control" id="Address" name="Address" placeholder="Masukkan alamat" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label mb-2" for="City">Kota</label>
                        <input type="text" class="form-control" id="City" name="City" placeholder="Masukkan kota" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label mb-2" for="Province">Provinsi</label>
                        <input type="text" class="form-control" id="Province" name="Province" placeholder="Masukkan provinsi" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label mb-2" for="Phone">No. Telepon</label>
                        <input type="text" class="form-control" id="Phone" name="Phone" placeholder="Masukkan nomor telepon" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label mb-2" for="PIC">Penanggung Jawab (PIC)</label>
                        <input type="text" class="form-control" id="PIC" name="PIC" placeholder="Masukkan nama penanggung jawab" required>
                    </div>

                    <div class="order-type"></div>
                </form>

                <div class="offcanvas-footer tbf flex-align-center flex-nowrap gap-3 border-0 pt-3 px-0 pb-0" style='border-bottom:1px solid rgba(var(--line-color), 1);'>
                    <span class="btn theme-btn w-100 mt-0 pulse simpancust">Simpan</span>
                    <span class="btn white-btn title-color w-100 mt-0" onclick="closePopup()">Cancel</a>
                </div>
            </div>
        </div>

        </main>

    <section class="panel-space"></section>
    <script src="./assets/js/script.js"></script>
    <script>
        let openPopup = ()=>document.getElementById('modpop').classList.add('show');
        let closePopup = ()=>document.getElementById('modpop').classList.remove('show');
    
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        const limit = 10;
        let currentSearch = '';
        let searchTimeout = null;
    
        const showSkeleton = count => {
            const placeList = document.getElementById('placeList');
            placeList.insertAdjacentHTML('beforeend',
                Array.from({ length: count }).map(() => `
                    <li class="recent-place-item skeleton-loader" style="display:block;">
                        <div class="card-name skeleton-loader-line" style="height:20px;width:60%;"></div>
                        <div class="address skeleton-loader-line" style="height:15px;width:80%;margin-top:5px;"></div>
                    </li>
                `).join('')
            );
        };
    
        const removeSkeleton = () => {
            document.querySelectorAll('.skeleton-loader').forEach(el => el.remove());
        };
    
        const getHariMon1 = (d) => ((d.getDay() + 6) % 7) + 1;
        const getMingguKe = (d) => {
            const first = new Date(d.getFullYear(), d.getMonth(), 1);
            const firstDowMon1 = getHariMon1(first);
            const offset = firstDowMon1 - 1;
            return Math.floor((offset + d.getDate() - 1) / 7) + 1;
        };
        const fmtDateTime = (d) => {
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        };
    
        const addToJadwal = async (store) => {
            const now = new Date();
            const minggu = String(getMingguKe(now));
            const hari = String(getHariMon1(now));
            const userCode = document.getElementById("usercode") ? document.getElementById("usercode").value : "";
            const payload = {
                carcode: store.CardCode,
                cardname: store.CardName,
                usercode: userCode,
                foto: null,
                lat: null,
                lon: null,
                start_kunjungan: null,
                end_kunjungan: null,
                created_by: userCode,
                minggu,
                hari,
                result: null,
                created_at: fmtDateTime(now)
            };
            try {
                const response = await fetch(urlbe + "addtojadwal", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    showToast(`${store.CardName} ditambahkan ke jadwal.`, "success");
                } else {
                    showToast("Tidak bisa menambahkan ke jadwal.", "danger");
                }
            } catch (e) {
                console.error("Error addToJadwal:", e);
                showToast("Tidak dapat terhubung ke server.", "danger");
            }
        };
    
        const renderStores = (stores, placeList, templateItem) => {
            stores.forEach(store => {
                const li = templateItem.cloneNode(true);
                li.style.display = 'block';
                li.querySelector('.card-name').textContent = store.CardName;
                li.querySelector('.address').textContent = `${store.Address} - ${store.City}`;
                li.onclick = () => addToJadwal(store);
                placeList.appendChild(li);
            });
        };
    
        let simpancust = document.querySelector(".simpancust");
        simpancust.onclick = async function() {
            let form = document.querySelector(".theme-form");
            let formData = new FormData(form);
            let data = {};
            let kosong = false;
            formData.forEach(function(value,key){
                data[key] = value.trim();
                if(!value.trim()) kosong = true;
            });
            let userCode = document.getElementById("usercode") ? document.getElementById("usercode").value : "";
            data["usercode"] = userCode;
    
            closePopup();
            if (kosong) {
                showToast("Semua field harus diisi.", "danger");
                openPopup();
                return;
            }
    
            try{
                let response = await fetch(urlbe+"addpelanggan",{
                    method:"POST",
                    headers:{"Content-Type":"application/json"},
                    body:JSON.stringify(data)
                });
                if(response.ok){
                    showToast("Data pelanggan berhasil disimpan.", "success");
                    form.reset();
                    window.location.href = './index.html';
                }else{
                    showToast("Terjadi kesalahan saat menyimpan data.", "danger");
                }
            }catch{
                showToast("Tidak dapat terhubung ke server.", "danger");
            }
        };
    
        const placeList = document.getElementById('placeList');
        const templateItem = document.querySelector('.recent-place-item');
    
        const fetchAndRenderStores = async (reset = false) => {
            if (isLoading || !hasMore) return;
            isLoading = true;
    
            if (reset) {
                placeList.innerHTML = '';
                placeList.appendChild(templateItem.cloneNode(true));
                currentPage = 1;
                hasMore = true;
            }
    
            showSkeleton(limit);
            try {
                const response = await fetch(urlbe+'caripelanggan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ search: currentSearch, page: currentPage, limit })
                });
                const result = await response.json();
    
                removeSkeleton();
                if (response.ok && result.status === 'success' && result.data?.length > 0) {
                    renderStores(result.data, placeList, templateItem);
                    currentPage++;
                    hasMore = result.pagination?.hasMore ?? false;
                } else {
                    hasMore = false;
                    if (currentPage === 1) {
                        placeList.innerHTML = '<li><img class="e404" src="./assets/images/kosong.svg" alt="Not Found"/><p>Tidak ada data ditemukan.</p></li>';
                    }
                }
            } catch (e) {
                console.error('Error fetching store data:', e);
                removeSkeleton();
                if (currentPage === 1) {
                    placeList.innerHTML = '<li><img class="e404" src="./assets/images/kosong.svg" alt="Not Found"/><p>Terjadi kesalahan saat memuat data.</p></li>';
                }
                showToast("Terjadi kesalahan saat memuat data.", "danger");
            }
            isLoading = false;
        };
    
        const handleSearch = e => {
            currentSearch = e.target.value.trim();
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchAndRenderStores(true);
            }, 800);
        };
    
        let searchInput = document.getElementById("searchInput"),
            clearBtn = document.getElementById("clearBtn");
        searchInput.onkeyup = (el)=>{
            if(el.key =='Backspace' && el.target.value ==''){
                clearBtn.click();
            }
            clearBtn.style.display = el.target.value !== '' ? "block" : "none";
        };
    
        clearBtn.onclick = ()=>{
            searchInput.value = "";
            clearBtn.style.display = "none";
            currentSearch = "";
            currentPage = 1;
            hasMore = true;
            fetchAndRenderStores(true);
        };
    
        document.getElementById('addform').onclick =()=> openPopup();
        document.getElementById('olay').onclick =()=> closePopup();
    
        searchInput.oninput = handleSearch;
        window.onscroll = () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                fetchAndRenderStores();
            }
        };
        fetchAndRenderStores();
    </script>
    

</body>
</html>