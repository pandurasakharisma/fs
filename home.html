<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <title>FS CRM</title>
    <style>
        
        .addcust svg {
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            z-index: 9999;
            border-radius: 50%;
            background: #c53f3f;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: pulse 1.5s infinite;
            transition: transform 0.2s ease-in-out;
        }
        .pulse{animation: pulse 1.5s infinite;}
        .addcust svg path {stroke: #fff!important;}
        @keyframes pulse {
            0% {transform: scale(1);box-shadow: 0 0 0 0 rgba(197, 63, 63, 0.4);}
            70% {transform: scale(1.1);box-shadow: 0 0 0 20px rgba(197, 63, 63, 0);}
            100% {transform: scale(1);box-shadow: 0 0 0 0 rgba(197, 63, 63, 0);}
        }

        .addcust svg:hover {transform: scale(1.15);}
    </style>
</head>

<body>
        <!-- header starts -->
        <header id="header" class="main-header">
        <div class="custom-container">
            <div class="header-panel">
                <div class="flex-align-center gap-2">
                    <a href="#offcanvasLeft" data-bs-toggle="offcanvas">
                        <i class="iconsax icon-btn" data-icon="text-align-left"> </i>
                    </a>
                    <img class="img-fluid logo user-logo" src="./assets/images/logo/user/logo-white.svg"
                        alt="logo">
                </div>

                <div class="flex-align-center gap-sm-3 gap-2">
                    <a href="chatting.html">
                        <i class="iconsax icon-btn" data-icon="messages-2"> </i>
                    </a>
                    <a href="notification.html">
                        <i class="iconsax icon-btn noti-icon" data-icon="bell-2"> </i>
                    </a>
                </div>
            </div>
        </div>
    </header>
    <!-- header end -->

    <!-- search section starts -->
    <section class="home-profile-section section-b-space pt-0">
        <div class="custom-container">
            <div class="form-input">
                <input type="search" class="form-control with-icon" id="inputusername"
                    placeholder="Search destinations">
                <i class="iconsax search-icon" data-icon="search-normal-2"> </i>
                <a href="date-time-schedule.html" class="date-time-picker">
                    <i class="iconsax icon" data-icon="calendar-1">
                    </i>
                </a>
            </div>
        </div>
    </section>

    <section>
        <div class="custom-container">
            <ul class="my-ride-list" style="margin-top: 0;"></ul>
        </div>
    </section>

    <!-- panel-space start -->
    <section class="panel-space"></section>
    <!-- panel-space end -->

    <!-- bottom navbar start -->
    <div class="navbar-menu">
        <ul>
            <li class="active">
                <a href="home.html">
                    <div class="icon">
                        <img class="unactive" src="./assets/images/svg/home.svg" alt="home">
                        <img class="active" src="./assets/images/svg/home-fill.svg" alt="home">
                    </div>
                    <span class="active">Home</span>
                </a>
            </li>

            <li>
                <a href="category.html">
                    <div class="icon">
                        <img class="unactive" src="./assets/images/svg/category.svg" alt="category">
                        <img class="active" src="./assets/images/svg/category-fill.svg" alt="category">
                    </div>
                    <span>Category</span>
                </a>
            </li>

            <li>
                <a href="my-rides.html">
                    <div class="icon">
                        <img class="unactive" src="./assets/images/svg/car.svg" alt="car">
                        <img class="active" src="./assets/images/svg/car-fill.svg" alt="car">
                    </div>
                    <span>My Rides</span>
                </a>
            </li>

            <li>
                <a href="setting.html">
                    <div class="icon">
                        <img class="unactive" src="./assets/images/svg/setting.svg" alt="setting">
                        <img class="active" src="./assets/images/svg/setting-fill.svg" alt="setting">
                    </div>
                    <span>Setting</span>
                </a>
            </li>
        </ul>
    </div>
    <!-- bottom navbar end -->

    <!-- sidebar starts -->
    <div class="offcanvas sidebar-offcanvas offcanvas-start" tabindex="-1" id="offcanvasLeft">
        <div class="offcanvas-header sidebar-header">
            <div class="sidebar-logo">
                <img class="img-fluid logo" src="./assets/images/logo/user/logo-utama.svg" alt="logo">
                <img class="img-fluid logo-dark" src="./assets/images/logo/user/user-logo-dark.png" alt="logo">
            </div>
        </div>
        <div class="offcanvas-body">
            <a href="profile-setting.html" class="profile-part flex-align-center gap-2">
                <img class="img-fluid profile-pic" src="./assets/images/profile/p8.png" alt="p8">
                <div>
                    <h3>Jauhari Malik</h3>
                    <span>Edit Account</span>
                </div>
            </a>
            <ul class="link-section switch-section">
                <li class="active">
                    <a href="home.html" class="pages">
                        <i class="iconsax sidebar-icon" data-icon="home-2"> </i>
                        <h3>Home</h3>
                    </a>
                </li>
                <li>
                    <a href="my-rides.html" class="pages">
                        <i class="iconsax sidebar-icon" data-icon="car"> </i>
                        <h3>My Ride</h3>
                    </a>
                </li>
                <li>
                    <a href="notification.html" class="pages">
                        <i class="iconsax sidebar-icon" data-icon="bell-2"> </i>
                        <h3>Notification</h3>
                    </a>
                </li>

                <li>
                    <a href="setting.html" class="pages">
                        <i class="iconsax sidebar-icon" data-icon="user-1"> </i>
                        <h3>Setting</h3>
                    </a>
                </li>
                <li>
                    <a href="page-listing.html" class="pages">
                        <i class="iconsax sidebar-icon" data-icon="book-closed"> </i>
                        <h3>Template Pages</h3>
                    </a>
                </li>

                <li>
                    <a href="../template/elements/elements-page.html" class="pages">
                        <i class="iconsax sidebar-icon" data-icon="document-text-1"> </i>
                        <h3> Template Elements</h3>
                    </a>
                </li>


                <li>
                    <div class="pages">
                        <i class="iconsax sidebar-icon" data-icon="repeat"> </i>
                        <h3>RTL</h3>
                    </div>
                    <div class="switch-btn">
                        <input id="dir-switch" type="checkbox">
                    </div>
                </li>

                <li>
                    <div class="pages">
                        <i class="iconsax sidebar-icon" data-icon="brush-3"> </i>
                        <h3>Dark</h3>
                    </div>
                    <div class="switch-btn">
                        <input id="dark-switch" type="checkbox">
                    </div>
                </li>

            </ul>

            <div class="bottom-sidebar">
                <a href="login.html" class="pages">
                    <i class="iconsax sidebar-icon" data-icon="logout-2"> </i>
                    <h3>Logout</h3>
                </a>
            </div>
        </div>
    </div>
    <!-- sidebar end -->
    <a href="./listpelanggan.html" class="iconsax addcust" data-icon="add" id="addform">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 12H18" stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M12 18V6" stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
    </a>
    <script src="./assets/js/script.js"></script>
    <script src="./assets/js/sweetalert.js"></script>
    <script>
        let waitUsercode = setInterval(() => {
            let el = document.getElementById("usercode")
            if (el) {
                clearInterval(waitUsercode)
                setTimeout(() => loadJadwal(el.value), 3000)
            }
        }, 500)

        let loadJadwal = usercode => {
            let { minggu, hari } = getMingguHari()

            fetch(urlbe + "listjadwal", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ usercode, minggu, hari })
            })
            .then(r => r.json())
            .then(res => {
                let list = document.querySelector(".my-ride-list")
                let data = res.data || []

                // DISTINCT berdasarkan cust_name â†’ ambil yang created_at paling baru
                let mapCust = {}
                data.forEach(d => {
                    let key = d.cust_name || '-'
                    if (!mapCust[key] || new Date(d.created_at) > new Date(mapCust[key].created_at)) {
                        mapCust[key] = d
                    }
                })
                let distinctData = Object.values(mapCust)

                list.innerHTML = distinctData.map(d => {
                    let status = d.end_kunjungan ? "done" : "waiting"
                    let tanggal = d.created_at ? formatDateIndo(d.created_at.split('T')[0]) : ''
                    let start = formatTime(d.start_kunjungan)
                    let end = formatTime(d.end_kunjungan)
                    let jam = (start && end) ? `${start} - ${end}` : ''
                    let jamClass = jam ? '' : 'hide'

                    console.log(d);

                    return `
                    <li>
                        <div class="my-ride-box">
                            <div class="my-ride-head">
                                <div class="my-ride-content flex-column" style="width:100%;margin:0 5px 0;">
                                    <div class="flex-spacing">
                                        <a href="#"><h6 class="title-color fw-medium">${d.cust_name||'-'}</h6></a>
                                        <span class="status accent-color fw-normal">${status}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="my-ride-details">
                                <div class="ride-info" style="flex-direction:unset;width:100%;margin:5px 5px 0;">
                                    ${d.Full_Name ? `
                                    <div class="ride-info-content">
                                        <div class="d-flex align-content-center gap-2 lh-base">
                                            <h5 class="fw-normal title-color">${d.Full_Name}</h5>
                                            <div class="flex-align-center gap-1"></div>
                                        </div>
                                        <h6 class="fw-normal content-color mt-1">${d.Job_Position||''}</h6>
                                    </div>`:''}
                                </div>

                                <ul class="ride-location-listing mt-3">
                                    <li class="location-box">
                                        <img class="icon" src="./assets/images/svg/location-fill.svg" alt="location">
                                        <h5 class="fw-light title-color">${d.Address||''}</h5>
                                    </li>
                                    <li class="location-box ${(!tanggal && !jam) ? 'hide':''}">
                                        <img class="icon" src="./assets/images/svg/gps.svg" alt="gps">
                                        <div class="flex-spacing" style="width:100%;">
                                            <span class="fw-light title-color border-0">${tanggal}</span>
                                            <span class="fw-light title-color border-0 ml-auto ${jamClass}">${jam}</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </li>
                    `
                }).join('')
            })
        }
    </script>
</body>
</html>